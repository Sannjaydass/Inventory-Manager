<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Manager</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body {
            margin: 0;
            height: 100vh;
            overflow: auto;
            background: linear-gradient(to bottom, #005f9e, #001f3f);
            position: relative;
            font-family: 'Poppins', sans-serif;
            color: white;
        }

        .bubble {
            position: absolute;
            bottom: -100px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: rise 10s infinite ease-in;
            z-index: 1;
        }

        @keyframes rise {
            from {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            to {
                transform: translateY(-1200px) scale(1.5);
                opacity: 0;
            }
        }

        .octopus {
            position: absolute;
            bottom: 50px;
            left: 20%;
            width: 150px;
            animation: floaty 8s ease-in-out infinite;
            z-index: 1;
        }

        @keyframes floaty {
            0%, 100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        .container {
            position: relative;
            z-index: 10;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .search-input {
            max-width: 300px;
        }

        table {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            overflow: hidden;
            border: none;
        }

        th {
            background-color: #00bfff;
            color: white;
            text-align: center;
            border: none;
            font-weight: 600;
        }

        td {
            vertical-align: middle !important;
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .preview img, .preview video {
            max-width: 100px;
            border-radius: 5px;
            margin: 5px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .inventory-title {
            color: white;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 191, 255, 0.7);
        }

        .action-btn {
            margin: 0 3px;
        }

        .btn-success {
            background-color: #00bfff;
            border-color: #0088cc;
            border-radius: 10px;
        }

            .btn-success:hover {
                background-color: #0088cc;
                border-color: #006699;
            }

        .btn-primary {
            background-color: #00bfff;
            border-color: #0088cc;
            border-radius: 10px;
        }

            .btn-primary:hover {
                background-color: #0088cc;
                border-color: #006699;
            }

        .btn-warning {
            background-color: #ffa500;
            border-color: #cc8400;
            border-radius: 10px;
        }

        .btn-danger {
            background-color: #ff6b6b;
            border-color: #ff5252;
            border-radius: 10px;
        }

        .modal-content {
            background: linear-gradient(to bottom, #005f9e, #001f3f);
            color: white;
            border-radius: 20px;
            border: none;
        }

        .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .close {
            color: white;
            opacity: 0.8;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 10px;
        }

            .form-control:focus {
                background: rgba(255, 255, 255, 0.2);
                border-color: #00bfff;
                color: white;
                box-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
            }

            .form-control::placeholder {
                color: rgba(255, 255, 255, 0.7);
            }

        /* FIXED DROPDOWN STYLES */
        select.form-control {
            background: rgba(255, 255, 255, 0.1) !important;
            color: white !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
        }

            select.form-control option {
                background: #005f9e !important;
                color: white !important;
                padding: 10px !important;
            }

            select.form-control:focus {
                background: rgba(255, 255, 255, 0.2) !important;
                color: white !important;
            }

        /* Dropdown arrow color */
        select.form-control {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 10px center !important;
            background-size: 16px !important;
        }

        .table-striped > tbody > tr:nth-of-type(odd) {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .table-striped > tbody > tr:nth-of-type(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* Drag & Drop Styles */
        .drop-zone {
            border: 2px dashed #00bfff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
        }

            .drop-zone:hover, .drop-zone.dragover {
                background: rgba(0, 191, 255, 0.1);
                border-color: #ffffff;
            }

            .drop-zone i {
                font-size: 48px;
                color: #00bfff;
                margin-bottom: 15px;
            }

        .file-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 5px;
            margin: 5px;
        }

        .search-filters {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            margin-bottom: 10px;
        }

        .asset-badge {
            background: #00bfff;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
        }

        /* Edit modal specific styles */
        .current-file-info {
            background: rgba(0, 191, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <!-- Animated Background Elements -->
    <script>
        for (let i = 0; i < 15; i++) {
            let bubble = document.createElement('div');
            bubble.classList.add('bubble');
            bubble.style.width = bubble.style.height = Math.random() * 30 + 10 + 'px';
            bubble.style.left = Math.random() * 100 + 'vw';
            bubble.style.animationDuration = Math.random() * 5 + 8 + 's';
            document.body.appendChild(bubble);
        }
    </script>

    <img src="https://pngimg.com/uploads/octopus/octopus_PNG37.png" class="octopus">

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h2 class="inventory-title">ðŸ“¦ Asset Manager</h2>
                <input type="text" id="searchInput" class="form-control search-input" placeholder="Search assets...">
            </div>
            <button class="btn btn-success" data-toggle="modal" data-target="#uploadModal">
                <i class="fas fa-plus"></i> Upload Asset
            </button>
        </div>

        <!-- Search Filters -->
        <div class="search-filters">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Asset Type:</label>
                        <select class="form-control" id="typeFilter">
                            <option value="">All Types</option>
                            <option value="image">Images</option>
                            <option value="document">Documents</option>
                            <option value="video">Videos</option>
                            <option value="audio">Audio</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Date From:</label>
                        <input type="date" class="form-control" id="dateFrom">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Date To:</label>
                        <input type="date" class="form-control" id="dateTo">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Tags:</label>
                        <input type="text" class="form-control" id="tagsFilter" placeholder="Filter by tags...">
                    </div>
                </div>
            </div>
        </div>

        <!-- Assets Table -->
        <div class="table-responsive">
            <table class="table table-bordered table-striped" id="assetsTable">
                <thead>
                    <tr>
                        <th style="width:5%">ID</th>
                        <th style="width:15%">Name</th>
                        <th style="width:10%">Type</th>
                        <th style="width:10%">Quantity</th>
                        <th style="width:15%">Date</th>
                        <th style="width:20%">Description</th>
                        <th style="width:15%">Preview</th>
                        <th style="width:10%">Actions</th>
                    </tr>
                </thead>
                <tbody id="assetsBody">
                    {% if items %}
                    {% for item in items %}
                    <tr>
                        <td class="text-center">{{ item.id }}</td>
                        <td>{{ item.name }}</td>
                        <td class="text-center">
                            <span class="asset-badge">{{ item.asset_type|default:"other" }}</span>
                        </td>
                        <td class="text-center">{{ item.quantity }}</td>
                        <td class="text-center">{{ item.date|date:"Y-m-d" }}</td>
                        <td>{{ item.description }}</td>
                        <td>
                            <div class="preview">
                                {% if item.file %}
                                {% if item.asset_type == 'image' %}
                                <img src="{{ item.file.url }}" class="file-preview" alt="{{ item.name }}">
                                {% elif item.asset_type == 'video' %}
                                <video controls class="file-preview">
                                    <source src="{{ item.file.url }}" type="video/mp4">
                                </video>
                                {% else %}
                                <i class="fas fa-file" style="font-size: 24px;"></i>
                                {% endif %}
                                {% else %}
                                <span class="text-muted">No file</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-warning btn-xs action-btn editBtn" data-id="{{ item.id }}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-xs action-btn deleteBtn" data-id="{{ item.id }}">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% if item.file %}
                            <button class="btn btn-info btn-xs action-btn downloadBtn" data-id="{{ item.id }}">
                                <i class="fas fa-download"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center">No assets found</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Upload Modal with Drag & Drop -->
    <div id="uploadModal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Upload Asset</h4>
                </div>
                <div class="modal-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- Drag & Drop Zone -->
                        <div class="drop-zone" id="dropZone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h4>Drag & Drop files here</h4>
                            <p>or click to select files</p>
                            <input type="file" id="fileInput" name="file" style="display: none;" accept="*/*">
                            <div id="filePreview" class="mt-3"></div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Asset Name:</label>
                                    <input type="text" class="form-control" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Asset Type:</label>
                                    <select class="form-control" name="asset_type">
                                        <option value="image">Image</option>
                                        <option value="document">Document</option>
                                        <option value="video">Video</option>
                                        <option value="audio">Audio</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Quantity:</label>
                                    <input type="number" class="form-control" name="quantity" value="1" min="1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Tags (comma separated):</label>
                                    <input type="text" class="form-control" name="tags" placeholder="tag1, tag2, tag3">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Description:</label>
                            <textarea class="form-control" name="description" rows="3" placeholder="Asset description..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-upload"></i> Upload Asset
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Edit Asset</h4>
                </div>
                <div class="modal-body">
                    <form id="editForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" id="editId" name="id">

                        <div class="current-file-info">
                            <h5>Current File Information</h5>
                            <p id="currentFileName">File: <span id="fileNameText"></span></p>
                            <p id="currentFileType">Type: <span id="fileTypeText"></span></p>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Asset Name:</label>
                                    <input type="text" class="form-control" id="editName" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Asset Type:</label>
                                    <select class="form-control" id="editType" name="asset_type">
                                        <option value="image">Image</option>
                                        <option value="document">Document</option>
                                        <option value="video">Video</option>
                                        <option value="audio">Audio</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Quantity:</label>
                                    <input type="number" class="form-control" id="editQuantity" name="quantity" value="1" min="1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Tags (comma separated):</label>
                                    <input type="text" class="form-control" id="editTags" name="tags" placeholder="tag1, tag2, tag3">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Description:</label>
                            <textarea class="form-control" id="editDescription" name="description" rows="3" placeholder="Asset description..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>Replace File (optional):</label>
                            <input type="file" class="form-control" name="file" accept="*/*">
                            <small class="text-muted">Leave empty to keep the current file</small>
                        </div>

                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <script>
        // Drag & Drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            filePreview.innerHTML = '';
            const fileElement = document.createElement('div');
            fileElement.className = 'alert alert-info';
            fileElement.innerHTML = `
                <strong>Selected file:</strong> ${file.name}<br>
                <small>Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
            `;
            filePreview.appendChild(fileElement);
        }

        // Upload form handling
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch('/upload/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    $('#uploadModal').modal('hide');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Upload error: ' + error);
            });
        });

        // Edit functionality
        $(document).on('click', '.editBtn', function() {
            const itemId = $(this).data('id');
            const row = $(this).closest('tr');

            // Get data from the row
            const name = row.find('td:eq(1)').text();
            const type = row.find('td:eq(2) .asset-badge').text().trim();
            const quantity = row.find('td:eq(3)').text();
            const description = row.find('td:eq(5)').text();

            // Get file info
            const preview = row.find('.preview');
            let fileName = "No file";
            if (preview.find('img').length > 0) {
                fileName = preview.find('img').attr('alt') || "Image file";
            } else if (preview.find('video').length > 0) {
                fileName = "Video file";
            } else if (preview.find('.fa-file').length > 0) {
                fileName = "Document file";
            }

            // Populate the edit form
            $('#editId').val(itemId);
            $('#editName').val(name);
            $('#editQuantity').val(quantity);
            $('#editDescription').val(description);
            $('#fileNameText').text(fileName);
            $('#fileTypeText').text(type);

            // Set the selected option in dropdown - FIXED
            $('#editType').val(type.toLowerCase());

            // If the current type doesn't match any option, set to 'other'
            if (!$('#editType').val()) {
                $('#editType').val('other');
            }

            // Show the edit modal
            $('#editModal').modal('show');
        });

        // Edit form submission
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch('/edit/' + $('#editId').val() + '/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    $('#editModal').modal('hide');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Edit error: ' + error);
            });
        });

        // Search and filter functionality
        function applyFilters() {
            const searchText = $('#searchInput').val().toLowerCase();
            const typeFilter = $('#typeFilter').val();
            const dateFrom = $('#dateFrom').val();
            const dateTo = $('#dateTo').val();
            const tagsFilter = $('#tagsFilter').val().toLowerCase();

            $('#assetsBody tr').each(function() {
                const $row = $(this);
                const name = $row.find('td:eq(1)').text().toLowerCase();
                const type = $row.find('td:eq(2)').text().toLowerCase();
                const date = $row.find('td:eq(4)').text();
                const description = $row.find('td:eq(5)').text().toLowerCase();

                const matchesSearch = name.includes(searchText) || description.includes(searchText);
                const matchesType = !typeFilter || type.includes(typeFilter);
                const matchesDate = (!dateFrom || date >= dateFrom) && (!dateTo || date <= dateTo);

                $row.toggle(matchesSearch && matchesType && matchesDate);
            });
        }

        $('#searchInput, #typeFilter, #dateFrom, #dateTo, #tagsFilter').on('input change', applyFilters);

        // Delete functionality
        $(document).on('click', '.deleteBtn', function() {
            const itemId = $(this).data('id');
            const itemName = $(this).closest('tr').find('td:eq(1)').text();

            if (confirm(`Delete "${itemName}"?`)) {
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                fetch('/delete/' + itemId + '/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                });
            }
        });

        $(document).on('click', '.downloadBtn', function() {
            const itemId = $(this).data('id');
            window.open('/download/' + itemId + '/', '_blank');
        });
    </script>

</body>
</html>